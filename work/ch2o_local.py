import numpy as np
from pyvib import Vibration, read_minfo #geometry, freq, displacement vector

geom = [['O',     [   0.0, 0.0, 0.0]],
        ['C',     [     -1.1996510872436317,       0.0,       0.0]],
        ['H',     [     0.6041071164352321, -0.944237356274768,    0.0]],
        ['H',     [     0.6041071164352321,  0.944237356274768,    0.0]]] # Angs

'''NOT dimensionless coordinate frequency'''
freq = [1193.495, 1264.160, 1529.535, 1863.269, 2867.313, 2926.465]

'''Normalized mass-weighted displacement vector'''
disp = [[-3.77832663e-05, -1.44206524e-01, -3.90016272e-02,
          1.37330386e-04,  4.99831945e-01,  1.34928755e-01,
          1.07701428e-04, -5.75125668e-01, -1.55109452e-01,
         -4.31056129e-04, -5.75116981e-01, -1.55104398e-01],
        [ 4.02853309e-06, -7.18872634e-02,  2.66462060e-01,
          1.15371251e-06,  1.15979195e-01, -4.29385874e-01,
         -5.61828755e-01, -5.67706738e-02,  2.10097471e-01,
          5.61808725e-01, -5.70452510e-02,  2.10019470e-01],
        [-3.00028578e-01,  7.61788379e-05,  1.97139367e-05,
          8.67375363e-03,  1.06048618e-06, -3.88969539e-06,
          5.82655326e-01,  8.82669590e-02, -3.28116731e-01,
          5.82671009e-01, -8.85741002e-02,  3.28051616e-01],
        [ 6.13995166e-01, -1.55619827e-04, -3.30190677e-05,
         -7.48945014e-01,  1.90049455e-04,  4.33612467e-05,
          6.91488917e-02,  4.21543319e-02, -1.56489074e-01,
          6.91423931e-02, -4.21901622e-02,  1.56470992e-01],
        [-4.07764541e-03,  7.56488909e-07,  2.30879745e-06,
         -1.97855754e-01,  8.38679699e-05, -1.04146966e-04,
          3.49610346e-01, -1.55904927e-01,  5.78117351e-01,
          3.49360671e-01,  1.55612517e-01, -5.77767176e-01],
        [ 2.98490039e-06, -8.90723115e-04,  3.30468722e-03,
          7.19831690e-05,  8.64782849e-02, -3.20876399e-01,
          3.51718386e-01, -1.47466018e-01,  5.46796360e-01,
         -3.51978664e-01, -1.47389841e-01,  5.47263255e-01]]#'Bohr(mass(AMU???) weighted)'
modes = [
                   [
                0.11487887649771573,
                0.5955363376797888,
                -0.16405236947580218,
                0.07146661289591401,
                -0.006752975009211358,
                -0.00580850174428562,
                -3.5613137438351437e-05,
                2.6182646224951824e-06,
                -0.006028483765845675,
                -0.7480023944868135,
                -0.2012346643448142,
                -7.05240548242444e-07
            ],
            [
                -0.7064905282687587,
                0.13554914669188656,
                -0.10405016057097598,
                -0.26621954453242536,
                -0.11778269585818654,
                -0.2779761121078486,
                0.00016952762322509267,
                0.4470052849211166,
                -0.00015443478608409244,
                3.168712006851315e-05,
                -2.1674139174643337e-05,
                0.33142272000354434
            ],
            [
                -0.1637888063679469,
                0.17571271248505835,
                0.6765828497656663,
                0.3273646800758968,
                -0.3218182884951259,
                0.0714260360867925,
                -0.5183604513522828,
                0.00016247177332814745,
                -8.237094254606205e-05,
                7.764428506584764e-06,
                -2.1929319785618517e-06,
                -5.483786220652593e-05
            ],
            [
                0.13250946336348926,
                0.687388653720878,
                -0.18950808350703446,
                0.0827431260354853,
                -0.007810545086290139,
                -0.006718023177383487,
                -7.196497518560469e-05,
                -2.3340429745540115e-05,
                0.2966747701159528,
                0.6156675713129752,
                -0.0031180872996739973,
                1.5544753375731896e-06
            ],
            [
                0.21866834488900241,
                -0.0542386033121083,
                -0.005316194235293652,
                -0.015812492099914033,
                -0.3596178212148999,
                -0.861925816181207,
                7.1099880931972244e-06,
                -0.2769703187874701,
                2.3803273776593283e-05,
                -7.254858653444339e-06,
                4.628309003974556e-06,
                -0.003222407682644314
            ],
            [
                0.06899366124777886,
                -0.06534727995673052,
                -0.23115582552596203,
                -0.147103445325079,
                -0.862843014772893,
                0.3857670174524887,
                0.1502760847968577,
                -7.860934847032063e-05,
                2.3885326135044558e-05,
                -2.2524040269224987e-06,
                6.367562639187102e-07,
                9.74336212196008e-06
            ],
            [
                -0.1716921391886545,
                0.21415556998811397,
                -0.07043225267357672,
                -0.03681034360090857,
                0.04223547087366521,
                0.10519435913037259,
                -0.00018125629439234308,
                -0.5603956397960126,
                -0.5807914109171411,
                0.06443811191382422,
                0.3535224615521307,
                0.3535554261189916
            ],
            [
                -0.33571053469447454,
                0.06590399012348983,
                -0.04463995180406201,
                -0.11397243755267081,
                -0.005847166603996702,
                -0.012159218670202815,
                0.00017807362841184264,
                -0.21861607935896188,
                -0.34437931507455466,
                0.16296773330724212,
                -0.5955932069380164,
                -0.5657832963604446
            ],
            [
                0.10208377926457543,
                0.2079548946591716,
                0.6367420171066095,
                -0.4316124612848757,
                0.0056101072608199,
                0.014581830844951574,
                0.5952811542802675,
                -0.0003579002021202212,
                5.085198550327502e-05,
                0.00012634409472713068,
                0.0001413884658470113,
                0.00016836106806834066
            ],
            [
                0.23821633593951727,
                0.13075126443473087,
                -0.024736650963535074,
                0.0786813727469782,
                -0.046167434837822124,
                -0.10855902572163599,
                0.0004633402535106461,
                0.560296010863313,
                -0.580829131547334,
                0.06448637880330768,
                0.3534378026493974,
                -0.3536479065349229
            ],
            [
                -0.3356879488474435,
                0.06595000036050423,
                -0.044717350292617725,
                -0.11398884613208674,
                -0.005856040997302198,
                -0.012188427703755918,
                -4.270600880285425e-05,
                -0.2184162249493698,
                0.34448418258593716,
                -0.16302320216057775,
                0.5957072914662745,
                -0.5656584713938839
            ],
            [
                -0.262065263659933,
                -0.03842147409102914,
                0.01077372110424479,
                0.7538553641355356,
                -0.06793636777411294,
                -0.04956287084854337,
                0.595281086429985,
                -0.00016178851254208473,
                0.00030991894604834514,
                -0.00018036215886404208,
                -0.0001024217362680081,
                0.00019866761494165521
            ]
]
disp = np.array(modes).T[6:]

U = np.load('U2.npy')
#U = np.eye(6)
print(np.array(disp)[2:4].reshape(2,-1,3))
#disp[3:5,:] *= -1
disp = U.T @ np.array(disp) # f x 3N-6 3N-6 x 3N
print(disp[2:4].reshape(2,-1,3))

freq = np.diag(U.T@np.diag(freq)@U)

#geom, freq, disp = read_minfo("sample/ch2o.minfo")


#sim = Vibration(geom, freq, disp)

#sim.localize(option='Boys')
#sim.localize(option='Pipek-Mezy', window=500)
#sim.visualize()
import numpy as np
#mw_hess = np.array(disp).T@np.diag(np.array(freq)**2)@np.array(disp)
#sim = Vibration(geom, mw_hess=np.array(mw_hess), unit_omega='cm-1', unit_mass='AMU')
sim = Vibration(geom, freq=freq, mw_disp=disp, unit_omega='cm-1', unit_mass='AMU', unit_xyz='angstrom', unit_xyz_hess='AMU')
#sim.group_localize(domain=[[0,1,2,3]], mw_hess=mw_hess, unit_omega='cm-1', unit_mass='AMU')
sim.visualize(blender=True, arrow_scale=5)
